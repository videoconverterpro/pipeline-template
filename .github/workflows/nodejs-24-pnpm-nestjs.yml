name: "NestJS CI/CD Pipeline (Node.js 24 + pnpm)"

# Workflow reutilizável para projetos NestJS com Node.js 24 e pnpm
# Este workflow é chamado por repositórios consumidores via workflow_call
# Path: v1/nodejs/24/pnpm/nestjs/github-pipeline.yml

on:
  workflow_call:

permissions:
  contents: read

jobs:
  # ============================================================================
  # STAGE 1: VALIDATION
  # Executa validações de segurança, qualidade e testes
  # ============================================================================
  validation:
    name: "[STAGE] Validation"
    runs-on: ubuntu-latest

    steps:
      # Checkout: Clonar repositório com histórico completo para GitLeaks
      - name: "[STEP] Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Histórico completo necessário para GitLeaks

      # SECURITY LAYER 1: Detecção de secrets vazados no código
      - name: "[STEP] GitLeaks"
        uses: videoconverterpro/pipeline-template/v1/shared/validations/gitleaks@main
        with:
          gitleaks-version: 'v8.21.2'

      # Setup: Instalar Node.js 24 e pnpm (fixo para este pipeline)
      - name: "[STEP] Setup Node.js 24 + pnpm"
        uses: videoconverterpro/pipeline-template/v1/nodejs/shared/validations/setup@main
        with:
          node-version: '24'
          package-manager: 'pnpm'

      # SECURITY LAYER 2: Auditoria de vulnerabilidades em dependências
      - name: "[STEP] npm audit"
        uses: videoconverterpro/pipeline-template/v1/nodejs/shared/validations/npm-audit@main
        with:
          severity-level: 'high'           # Falha apenas para HIGH e CRITICAL
          production-only: 'true'           # Ignora devDependencies
          continue-on-error: 'false'        # Bloqueia pipeline se encontrar vulnerabilidades

      # SECURITY LAYER 3: SAST - Análise estática de código
      - name: "[STEP] Semgrep"
        uses: videoconverterpro/pipeline-template/v1/shared/validations/semgrep@main
        with:
          config: 'auto'                    # Regras automáticas baseadas na linguagem
          severity: 'WARNING'               # Falha para WARNING e ERROR
          continue-on-error: 'false'        # Bloqueia pipeline se encontrar problemas

      # QUALITY: Validação de estilo e formatação de código
      - name: "[STEP] Lint"
        uses: videoconverterpro/pipeline-template/v1/nodejs/shared/validations/lint@main

      # QUALITY: Execução de testes automatizados
      - name: "[STEP] Test"
        uses: videoconverterpro/pipeline-template/v1/nodejs/shared/validations/test@main
        with:
          unit: 'true'                      # Testes unitários sempre executados
          integration: 'false'              # Testes de integração desabilitados
          e2e: 'true'                       # Testes E2E sempre executados
          coverage: 'false'                 # Cobertura de código desabilitada

      # SECURITY LAYER 4: Scan multi-propósito (vulnerabilidades, misconfigurations, secrets)
      - name: "[STEP] Trivy"
        uses: videoconverterpro/pipeline-template/v1/shared/validations/trivy@main
        with:
          scan-type: 'fs'                   # Scan de filesystem
          scan-path: '.'                    # Raiz do projeto
          severity: 'HIGH,CRITICAL'         # Apenas severidades altas
          exit-code: '1'                    # Falha se encontrar vulnerabilidades

  # ============================================================================
  # STAGE 2: BUILD
  # Compilação da aplicação NestJS
  # ============================================================================
  build:
    name: "[STAGE] Build"
    runs-on: ubuntu-latest
    needs: validation  # Só executa se validation passar

    steps:
      # Checkout: Jobs são isolados, precisa clonar novamente
      - name: "[STEP] Checkout"
        uses: actions/checkout@v4

      # Setup: Jobs não compartilham ambiente, precisa reinstalar Node.js e pnpm
      - name: "[STEP] Setup Node.js 24 + pnpm"
        uses: videoconverterpro/pipeline-template/v1/nodejs/shared/validations/setup@main
        with:
          node-version: '24'
          package-manager: 'pnpm'

      # Build: Compila aplicação NestJS e faz upload do artifact dist/
      - name: "[STEP] Build"
        uses: videoconverterpro/pipeline-template/v1/nodejs/shared/build/build@main
