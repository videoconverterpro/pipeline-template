# ============================================================================
# üèóÔ∏è WORKFLOW REUTILIZ√ÅVEL: Build e Artifact Upload
# ============================================================================
# 
# PROP√ìSITO:
#   Workflow gen√©rico para build de projetos Node.js e upload de artifacts:
#   - Executa script de build configurado (ex: nest build, tsc, webpack)
#   - Upload da pasta dist/ como artifact (7 dias reten√ß√£o)
#   100% reutiliz√°vel por qualquer projeto Node.js/NestJS/Express/React/etc.
#
# COMO USAR:
#   jobs:
#     build:
#       needs: [setup, quality]  # Executar ap√≥s setup e quality
#       uses: videoconverterpro/pipeline-template/.github/workflows/build-app.yml@main
#       with:
#         working-directory: '.'     # Opcional, padr√£o √© raiz
#         build-script: 'build'      # Opcional, padr√£o
#         dist-folder: 'dist'        # Opcional, padr√£o
#         artifact-retention: 7      # Opcional, dias de reten√ß√£o
#
# PR√â-REQUISITOS:
#   - node_modules instalado (executar workflow setup-node-pnpm antes)
#   - Script no package.json:
#     * "build": "nest build" (ou tsc, webpack, vite, etc)
#
# SA√çDAS:
#   - Pasta dist/ buildada
#   - Artifact uploadado: dist-<commit-sha>
#   - Reten√ß√£o configur√°vel (padr√£o: 7 dias)
#
# PROPRIEDADE:
#   Bruno Roberto Morillo - CPF: 460.876.598-11
#   ¬© 2025 VideoConverterPro - Todos os direitos reservados
#
# ============================================================================

name: "üèóÔ∏è Build e Artifact"

on:
  workflow_call:
    inputs:
      # Diret√≥rio de trabalho (para monorepos)
      working-directory:
        description: 'Diret√≥rio onde est√° o package.json'
        required: false
        type: string
        default: '.'
      
      # Script customizado de build
      build-script:
        description: 'Nome do script de build no package.json'
        required: false
        type: string
        default: 'build'
      
      # Nome da pasta de output do build
      dist-folder:
        description: 'Nome da pasta de output (dist, build, out, etc)'
        required: false
        type: string
        default: 'dist'
      
      # Dias de reten√ß√£o do artifact
      artifact-retention:
        description: 'Dias de reten√ß√£o do artifact no GitHub'
        required: false
        type: number
        default: 7

jobs:
  # ==========================================================================
  # JOB: Build e upload de artifact
  # ==========================================================================
  build:
    name: "üèóÔ∏è Build + Upload Artifact"
    runs-on: ubuntu-latest
    
    # Diret√≥rio padr√£o para todos os steps
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      # ======================================================================
      # STEP 1: Checkout do c√≥digo
      # ======================================================================
      - name: "üì• [STEP] Checkout c√≥digo"
        uses: actions/checkout@v4
      
      # ======================================================================
      # STEP 2: Setup Node.js + pnpm
      # ======================================================================
      - name: "üü¢ [STEP] Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: "üì¶ [STEP] Setup pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: '10'
      
      # ======================================================================
      # STEP 3: Restaurar cache de node_modules
      # ======================================================================
      # Reutiliza cache gerado pelo workflow setup-node-pnpm
      # Se cache MISS: Instala depend√™ncias
      # ======================================================================
      - name: "üíæ [ACTION] Restaurar cache - node_modules"
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: ${{ inputs.working-directory }}/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
      
      - name: "üì• [ACTION] Instalar depend√™ncias (se cache MISS)"
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: pnpm install --frozen-lockfile
      
      # ======================================================================
      # STEP 4: Restaurar cache do Prisma (se existir)
      # ======================================================================
      - name: "üíæ [ACTION] Restaurar cache - Prisma engines"
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.working-directory }}/node_modules/.prisma
            ${{ inputs.working-directory }}/node_modules/@prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}-${{ hashFiles(format('{0}/**/schema.prisma', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-prisma-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}-
            ${{ runner.os }}-prisma-
      
      # ======================================================================
      # STEP 5: Build da aplica√ß√£o
      # ======================================================================
      # Executa script configurado (padr√£o: build)
      # Exemplos comuns:
      #   - NestJS: "nest build"
      #   - TypeScript: "tsc"
      #   - React/Vite: "vite build"
      #   - Next.js: "next build"
      # ======================================================================
      - name: "üèóÔ∏è [ACTION] Build da aplica√ß√£o"
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üèóÔ∏è Buildando aplica√ß√£o..."
          pnpm run ${{ inputs.build-script }}
          echo "‚úÖ Build conclu√≠do com sucesso!"
          
          # Verifica se pasta de output existe
          if [ ! -d "${{ inputs.dist-folder }}" ]; then
            echo "‚ùå Erro: Pasta '${{ inputs.dist-folder }}' n√£o encontrada ap√≥s build!"
            exit 1
          fi
          
          echo "üì¶ Conte√∫do da pasta ${{ inputs.dist-folder }}:"
          ls -lah ${{ inputs.dist-folder }}
      
      # ======================================================================
      # STEP 6: Upload do artifact
      # ======================================================================
      # Faz upload da pasta dist/ como artifact
      # Nome: dist-<commit-sha> (√∫nico por commit)
      # Reten√ß√£o: Configur√°vel (padr√£o 7 dias)
      # √ötil para deploy manual ou troubleshooting
      # ======================================================================
      - name: "üì§ [ACTION] Upload artifact - ${{ inputs.dist-folder }}"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.dist-folder }}-${{ github.sha }}
          path: ${{ inputs.working-directory }}/${{ inputs.dist-folder }}
          retention-days: ${{ inputs.artifact-retention }}
          if-no-files-found: error
      
      # ======================================================================
      # STEP 7: Sucesso
      # ======================================================================
      - name: "üéâ [STEP] Build conclu√≠do"
        shell: bash
        run: |
          echo "‚úÖ Build realizado com sucesso!"
          echo "üì¶ Artifact: ${{ inputs.dist-folder }}-${{ github.sha }}"
          echo "‚è∞ Reten√ß√£o: ${{ inputs.artifact-retention }} dias"
