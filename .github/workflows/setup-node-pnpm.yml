# ============================================================================
# üîß WORKFLOW REUTILIZ√ÅVEL: Setup Node.js + pnpm + Cache
# ============================================================================
# 
# PROP√ìSITO:
#   Workflow gen√©rico para configurar ambiente Node.js com pnpm e sistema
#   de cache multi-camadas (node_modules, Prisma engines, pnpm store).
#   100% reutiliz√°vel por qualquer projeto Node.js/NestJS/Express/etc.
#
# COMO USAR:
#   jobs:
#     meu_job:
#       uses: videoconverterpro/pipeline-template/.github/workflows/setup-node-pnpm.yml@main
#       with:
#         node-version: '24'
#         pnpm-version: '10'
#         working-directory: '.'  # Opcional, padr√£o √© raiz
#
# SA√çDAS:
#   - Ambiente configurado: Node.js + pnpm instalados
#   - Depend√™ncias instaladas (via cache ou pnpm install)
#   - Prisma Client gerado (se existir schema.prisma)
#
# CACHE:
#   - Layer 1: pnpm store (~/.pnpm-store) - 60s economia
#   - Layer 2: node_modules - 60s economia (PRINCIPAL)
#   - Layer 3: Prisma engines - 30s economia
#   - Cache HIT total: ~85% mais r√°pido
#
# PROPRIEDADE:
#   Bruno Roberto Morillo - CPF: 460.876.598-11
#   ¬© 2025 VideoConverterPro - Todos os direitos reservados
#
# ============================================================================

name: "üîß Setup Node.js + pnpm"

on:
  workflow_call:
    inputs:
      # Vers√£o do Node.js (ex: '24', '20', '18')
      node-version:
        description: 'Vers√£o do Node.js'
        required: false
        type: string
        default: '24'
      
      # Vers√£o do pnpm (ex: '10', '9', '8')
      pnpm-version:
        description: 'Vers√£o do pnpm'
        required: false
        type: string
        default: '10'
      
      # Diret√≥rio de trabalho (para monorepos)
      working-directory:
        description: 'Diret√≥rio onde est√° o package.json'
        required: false
        type: string
        default: '.'

jobs:
  # ==========================================================================
  # JOB: Setup completo com cache
  # ==========================================================================
  setup:
    name: "üîß Setup Node.js ${{ inputs.node-version }} + pnpm ${{ inputs.pnpm-version }}"
    runs-on: ubuntu-latest
    
    # Diret√≥rio padr√£o para todos os steps
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      # ======================================================================
      # STEP 1: Checkout do c√≥digo
      # ======================================================================
      - name: "üì• [STEP] Checkout c√≥digo"
        uses: actions/checkout@v4
      
      # ======================================================================
      # STEP 2: Setup Node.js (SEM cache nativo para evitar conflito)
      # ======================================================================
      # N√£o usa cache: 'pnpm' pois o pnpm ainda n√£o est√° instalado
      # Cache manual ser√° configurado depois da instala√ß√£o do pnpm
      # ======================================================================
      - name: "üü¢ [STEP] Setup Node.js ${{ inputs.node-version }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          # ‚ö†Ô∏è N√ÉO usar cache: 'pnpm' aqui! (pnpm n√£o instalado ainda)
      
      # ======================================================================
      # STEP 3: Setup pnpm
      # ======================================================================
      - name: "üì¶ [STEP] Setup pnpm ${{ inputs.pnpm-version }}"
        uses: pnpm/action-setup@v4
        with:
          version: ${{ inputs.pnpm-version }}
      
      # ======================================================================
      # STEP 4: Cache - pnpm store (CAMADA 1)
      # ======================================================================
      # Cacheia o store global do pnpm (~/.pnpm-store)
      # Economia: ~60 segundos em cache hit
      # Chave: SO + hash do pnpm-lock.yaml
      # ======================================================================
      - name: "üíæ [ACTION] Cache - pnpm store"
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # ======================================================================
      # STEP 5: Cache - node_modules (CAMADA 2 - PRINCIPAL)
      # ======================================================================
      # Cacheia node_modules completo
      # Economia: ~60 segundos em cache hit (MAIS IMPORTANTE!)
      # Se cache HIT: pnpm install √© completamente PULADO
      # Chave: SO + hash do pnpm-lock.yaml
      # ======================================================================
      - name: "üíæ [ACTION] Cache - node_modules"
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: ${{ inputs.working-directory }}/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
      
      # ======================================================================
      # STEP 6: Cache - Prisma engines (CAMADA 3)
      # ======================================================================
      # Cacheia bin√°rios do Prisma (query-engine, schema-engine)
      # Economia: ~30 segundos em cache hit
      # Chave: SO + lock + schema.prisma (invalida se schema mudar)
      # ======================================================================
      - name: "üíæ [ACTION] Cache - Prisma engines"
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.working-directory }}/node_modules/.prisma
            ${{ inputs.working-directory }}/node_modules/@prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}-${{ hashFiles(format('{0}/**/schema.prisma', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-prisma-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}-
            ${{ runner.os }}-prisma-
      
      # ======================================================================
      # STEP 7: Instalar depend√™ncias (CONDICIONAL - apenas se cache MISS)
      # ======================================================================
      # S√≥ executa se node_modules N√ÉO foi restaurado do cache
      # --frozen-lockfile: Falha se lock desatualizado (n√£o modifica lock)
      # Garante instala√ß√£o determin√≠stica e reprodut√≠vel
      # ======================================================================
      - name: "üì• [ACTION] Instalar depend√™ncias (frozen-lockfile)"
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "‚ùå Cache MISS! Instalando depend√™ncias..."
          pnpm install --frozen-lockfile
      
      # ======================================================================
      # STEP 8: Verificar instala√ß√£o (sempre executa)
      # ======================================================================
      # Se cache HIT: Apenas confirma que tudo est√° OK
      # Se cache MISS: Confirma que instala√ß√£o foi bem-sucedida
      # Verifica se Prisma Client existe e regenera se necess√°rio
      # ======================================================================
      - name: "‚úÖ [ACTION] Verificar instala√ß√£o"
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ "${{ steps.node-modules-cache.outputs.cache-hit }}" == "true" ]; then
            echo "‚úÖ Cache HIT! Depend√™ncias restauradas do cache."
          else
            echo "‚úÖ Depend√™ncias instaladas com sucesso."
          fi
          
          echo ""
          echo "üì¶ Verificando Prisma Client..."
          
          # Verifica se existe schema.prisma
          if [ -f "prisma/schema.prisma" ]; then
            # Verifica se Prisma Client foi gerado
            if [ ! -d "node_modules/.prisma/client" ]; then
              echo "‚ö†Ô∏è  Prisma Client n√£o encontrado! Gerando..."
              pnpm prisma generate
            else
              echo "‚úÖ Prisma Client OK"
            fi
          else
            echo "‚ÑπÔ∏è  Projeto n√£o usa Prisma (schema.prisma n√£o encontrado)"
          fi
          
          echo ""
          echo "üéâ Setup conclu√≠do com sucesso!"
