# ============================================================================
# ‚úÖ WORKFLOW REUTILIZ√ÅVEL: Quality Check (Linting + Formatting)
# ============================================================================
# 
# PROP√ìSITO:
#   Workflow gen√©rico para valida√ß√£o de qualidade de c√≥digo:
#   - Prettier: Verifica formata√ß√£o (format:check)
#   - ESLint: Valida linting com --max-warnings 0 (lint:check)
#   100% reutiliz√°vel por qualquer projeto Node.js com scripts configurados.
#
# COMO USAR:
#   jobs:
#     quality:
#       needs: setup  # Executar ap√≥s setup
#       uses: videoconverterpro/pipeline-template/.github/workflows/quality-check.yml@main
#       with:
#         working-directory: '.'  # Opcional, padr√£o √© raiz
#         format-script: 'format:check'  # Opcional, padr√£o
#         lint-script: 'lint:check'      # Opcional, padr√£o
#
# PR√â-REQUISITOS:
#   - node_modules instalado (executar workflow setup-node-pnpm antes)
#   - Scripts no package.json:
#     * "format:check": "prettier --check ."
#     * "lint:check": "eslint . --max-warnings 0"
#
# VALIDA√á√ïES:
#   - Formata√ß√£o Prettier (fail-fast se c√≥digo mal formatado)
#   - Linting ESLint strict (fail-fast se warnings ou errors)
#   - Modo check-only (n√£o modifica c√≥digo)
#
# PROPRIEDADE:
#   Bruno Roberto Morillo - CPF: 460.876.598-11
#   ¬© 2025 VideoConverterPro - Todos os direitos reservados
#
# ============================================================================

name: "‚úÖ Quality Check"

on:
  workflow_call:
    inputs:
      # Diret√≥rio de trabalho (para monorepos)
      working-directory:
        description: 'Diret√≥rio onde est√° o package.json'
        required: false
        type: string
        default: '.'
      
      # Script customizado de formata√ß√£o
      format-script:
        description: 'Nome do script de format check no package.json'
        required: false
        type: string
        default: 'format:check'
      
      # Script customizado de linting
      lint-script:
        description: 'Nome do script de lint check no package.json'
        required: false
        type: string
        default: 'lint:check'

jobs:
  # ==========================================================================
  # JOB: Valida√ß√£o de qualidade
  # ==========================================================================
  quality-check:
    name: "‚úÖ Prettier + ESLint"
    runs-on: ubuntu-latest
    
    # Diret√≥rio padr√£o para todos os steps
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      # ======================================================================
      # STEP 1: Checkout do c√≥digo
      # ======================================================================
      - name: "üì• [STEP] Checkout c√≥digo"
        uses: actions/checkout@v4
      
      # ======================================================================
      # STEP 2: Setup Node.js + pnpm (SEM cache nativo)
      # ======================================================================
      - name: "üü¢ [STEP] Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: "üì¶ [STEP] Setup pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: '10'
      
      # ======================================================================
      # STEP 3: Restaurar cache de node_modules
      # ======================================================================
      # Reutiliza cache gerado pelo workflow setup-node-pnpm
      # Se cache MISS: Instala depend√™ncias
      # ======================================================================
      - name: "üíæ [ACTION] Restaurar cache - node_modules"
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: ${{ inputs.working-directory }}/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
      
      - name: "üì• [ACTION] Instalar depend√™ncias (se cache MISS)"
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: pnpm install --frozen-lockfile
      
      # ======================================================================
      # STEP 4: Prettier - Valida√ß√£o de formata√ß√£o
      # ======================================================================
      # Executa script configurado (padr√£o: format:check)
      # Falha se c√≥digo n√£o estiver formatado corretamente
      # Modo check-only: N√ÉO modifica arquivos
      # ======================================================================
      - name: "üíÖ [ACTION] Prettier - Validar formata√ß√£o"
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîç Verificando formata√ß√£o com Prettier..."
          pnpm run ${{ inputs.format-script }}
          echo "‚úÖ Formata√ß√£o OK!"
      
      # ======================================================================
      # STEP 5: ESLint - Valida√ß√£o de linting
      # ======================================================================
      # Executa script configurado (padr√£o: lint:check)
      # Falha se houver erros OU warnings (--max-warnings 0)
      # Modo check-only: N√ÉO modifica arquivos
      # ======================================================================
      - name: "üîç [ACTION] ESLint - Validar linting"
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîç Verificando linting com ESLint..."
          pnpm run ${{ inputs.lint-script }}
          echo "‚úÖ Linting OK!"
      
      # ======================================================================
      # STEP 6: Sucesso
      # ======================================================================
      - name: "üéâ [STEP] Quality check conclu√≠do"
        shell: bash
        run: |
          echo "‚úÖ C√≥digo est√° limpo e padronizado!"
          echo "‚úÖ Prettier: OK"
          echo "‚úÖ ESLint: OK"
