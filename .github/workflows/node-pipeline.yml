# ============================================================================
# üöÄ WORKFLOW REUTILIZ√ÅVEL: Pipeline Completa Node.js
# ============================================================================
# 
# PROP√ìSITO:
#   Workflow ALL-IN-ONE para valida√ß√£o completa de projetos Node.js:
#   1. Setup (Node.js + pnpm + cache multi-camadas)
#   2. Quality Check (Prettier + ESLint)
#   3. Build (compila√ß√£o + artifact upload)
#   
#   Tudo em um √∫nico workflow reutiliz√°vel!
#   100% compat√≠vel com reposit√≥rios privados.
#
# COMO USAR:
#   # No reposit√≥rio do projeto, criar .github/workflows/homolog.yml:
#   
#   name: Valida√ß√£o Homologa√ß√£o
#   on:
#     push:
#       branches: [homolog]
#   
#   jobs:
#     validate:
#       uses: videoconverterpro/pipeline-template/.github/workflows/node-pipeline.yml@main
#       with:
#         node-version: '24'
#         pnpm-version: '10'
#
# CUSTOMIZA√á√ïES:
#   - Vers√µes de Node.js e pnpm
#   - Diret√≥rio de trabalho (monorepos)
#   - Scripts customizados (build, lint, format)
#   - Reten√ß√£o de artifacts
#
# SA√çDAS:
#   - C√≥digo validado (formata√ß√£o + linting)
#   - Build compilado
#   - Artifact dispon√≠vel
#
# PROPRIEDADE:
#   Bruno Roberto Morillo - CPF: 460.876.598-11
#   ¬© 2025 VideoConverterPro - Todos os direitos reservados
#
# ============================================================================

name: "üöÄ Node.js Pipeline Completa"

on:
  workflow_call:
    inputs:
      # Vers√£o do Node.js
      node-version:
        description: 'Vers√£o do Node.js'
        required: false
        type: string
        default: '24'
      
      # Vers√£o do pnpm
      pnpm-version:
        description: 'Vers√£o do pnpm'
        required: false
        type: string
        default: '10'
      
      # Diret√≥rio de trabalho
      working-directory:
        description: 'Diret√≥rio onde est√° o package.json'
        required: false
        type: string
        default: '.'
      
      # Scripts customizados
      format-script:
        description: 'Script de format check'
        required: false
        type: string
        default: 'format:check'
      
      lint-script:
        description: 'Script de lint check'
        required: false
        type: string
        default: 'lint:check'
      
      build-script:
        description: 'Script de build'
        required: false
        type: string
        default: 'build'
      
      # Configura√ß√µes de build
      dist-folder:
        description: 'Pasta de output do build'
        required: false
        type: string
        default: 'dist'
      
      artifact-retention:
        description: 'Dias de reten√ß√£o do artifact'
        required: false
        type: number
        default: 7

jobs:
  # ==========================================================================
  # JOB √öNICO: Toda a pipeline em um job
  # ==========================================================================
  # Setup ‚Üí Quality ‚Üí Build ‚Üí Upload
  # Tudo executado sequencialmente no mesmo runner
  # ==========================================================================
  pipeline:
    name: "üöÄ Setup + Quality + Build"
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      # ======================================================================
      # STEP 1: Checkout do c√≥digo
      # ======================================================================
      - name: "üì• [STEP] Checkout c√≥digo"
        uses: actions/checkout@v4
      
      # ======================================================================
      # STEP 2: Setup Node.js (SEM cache nativo)
      # ======================================================================
      - name: "üü¢ [STEP] Setup Node.js ${{ inputs.node-version }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      
      # ======================================================================
      # STEP 3: Setup pnpm
      # ======================================================================
      - name: "üì¶ [STEP] Setup pnpm ${{ inputs.pnpm-version }}"
        uses: pnpm/action-setup@v4
        with:
          version: ${{ inputs.pnpm-version }}
      
      # ======================================================================
      # STEP 4: Cache - pnpm store
      # ======================================================================
      - name: "üíæ [ACTION] Cache - pnpm store"
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # ======================================================================
      # STEP 5: Cache - node_modules (PRINCIPAL)
      # ======================================================================
      - name: "üíæ [ACTION] Cache - node_modules"
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: ${{ inputs.working-directory }}/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
      
      # ======================================================================
      # STEP 6: Cache - Prisma engines
      # ======================================================================
      - name: "üíæ [ACTION] Cache - Prisma engines"
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.working-directory }}/node_modules/.prisma
            ${{ inputs.working-directory }}/node_modules/@prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}-${{ hashFiles(format('{0}/**/schema.prisma', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-prisma-${{ hashFiles(format('{0}/**/pnpm-lock.yaml', inputs.working-directory)) }}-
            ${{ runner.os }}-prisma-
      
      # ======================================================================
      # STEP 7: Instalar depend√™ncias (se cache MISS)
      # ======================================================================
      - name: "üì• [ACTION] Instalar depend√™ncias"
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "‚ùå Cache MISS! Instalando depend√™ncias..."
          pnpm install --frozen-lockfile
      
      # ======================================================================
      # STEP 8: Verificar instala√ß√£o
      # ======================================================================
      - name: "‚úÖ [ACTION] Verificar instala√ß√£o"
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ "${{ steps.node-modules-cache.outputs.cache-hit }}" == "true" ]; then
            echo "‚úÖ Cache HIT! Depend√™ncias restauradas do cache."
          else
            echo "‚úÖ Depend√™ncias instaladas com sucesso."
          fi
          
          # Verificar Prisma Client
          if [ -f "prisma/schema.prisma" ]; then
            if [ ! -d "node_modules/.prisma/client" ]; then
              echo "‚ö†Ô∏è  Gerando Prisma Client..."
              pnpm prisma generate
            else
              echo "‚úÖ Prisma Client OK"
            fi
          fi
      
      # ======================================================================
      # STEP 9: Prettier - Validar formata√ß√£o
      # ======================================================================
      - name: "üíÖ [ACTION] Prettier - Validar formata√ß√£o"
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîç Verificando formata√ß√£o..."
          pnpm run ${{ inputs.format-script }}
          echo "‚úÖ Formata√ß√£o OK!"
      
      # ======================================================================
      # STEP 10: ESLint - Validar linting
      # ======================================================================
      - name: "üîç [ACTION] ESLint - Validar linting"
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîç Verificando linting..."
          pnpm run ${{ inputs.lint-script }}
          echo "‚úÖ Linting OK!"
      
      # ======================================================================
      # STEP 11: Build da aplica√ß√£o
      # ======================================================================
      - name: "üèóÔ∏è [ACTION] Build da aplica√ß√£o"
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üèóÔ∏è Buildando aplica√ß√£o..."
          pnpm run ${{ inputs.build-script }}
          echo "‚úÖ Build conclu√≠do!"
          
          # Verificar se dist/ existe
          if [ ! -d "${{ inputs.dist-folder }}" ]; then
            echo "‚ùå Erro: Pasta '${{ inputs.dist-folder }}' n√£o encontrada!"
            exit 1
          fi
          
          echo "üì¶ Conte√∫do:"
          ls -lah ${{ inputs.dist-folder }}
      
      # ======================================================================
      # STEP 12: Upload artifact
      # ======================================================================
      - name: "üì§ [ACTION] Upload artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.dist-folder }}-${{ github.sha }}
          path: ${{ inputs.working-directory }}/${{ inputs.dist-folder }}
          retention-days: ${{ inputs.artifact-retention }}
          if-no-files-found: error
      
      # ======================================================================
      # STEP 13: Sucesso
      # ======================================================================
      - name: "üéâ [STEP] Pipeline conclu√≠da"
        shell: bash
        run: |
          echo "======================================"
          echo "‚úÖ PIPELINE CONCLU√çDA COM SUCESSO!"
          echo "======================================"
          echo ""
          echo "‚úÖ Setup: Node.js ${{ inputs.node-version }} + pnpm ${{ inputs.pnpm-version }}"
          echo "‚úÖ Quality: Prettier + ESLint"
          echo "‚úÖ Build: ${{ inputs.dist-folder }}/ gerado"
          echo ""
          echo "üì¶ Artifact: ${{ inputs.dist-folder }}-${{ github.sha }}"
          echo "‚è∞ Reten√ß√£o: ${{ inputs.artifact-retention }} dias"
          echo "üöÄ Pronto para deploy!"
